
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>RP6502-API &#8212; RP6502 0.0-pre documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="RP6502-VGA" href="vga.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="rp6502-api">
<h1>RP6502-API<a class="headerlink" href="#rp6502-api" title="Permalink to this headline">¶</a></h1>
<p>Rumbledethumps Picocomputer 6502 Application Programming Interface.</p>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">1. Introduction</a></p></li>
<li><p><a class="reference internal" href="#calling-with-fastcall" id="id2">2. Calling with fastcall</a></p>
<ul>
<li><p><a class="reference internal" href="#short-stacking" id="id3">2.1. Short Stacking</a></p></li>
<li><p><a class="reference internal" href="#shorter-integers" id="id4">2.2. Shorter Integers</a></p></li>
<li><p><a class="reference internal" href="#bulk-data" id="id5">2.3. Bulk Data</a></p>
<ul>
<li><p><a class="reference internal" href="#xx-0-bulk-vstack-operations" id="id6">2.2.1. $XX+0 Bulk VSTACK Operations</a></p></li>
<li><p><a class="reference internal" href="#xx-1-and-xx-2-bulk-vram-operations" id="id7">2.2.2. $XX+1 and $XX+2 Bulk VRAM Operations</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#function-reference" id="id8">1. Function Reference</a></p>
<ul>
<li><p><a class="reference internal" href="#warning" id="id9">Warning</a></p></li>
<li><p><a class="reference internal" href="#typedefs" id="id10">Typedefs</a></p></li>
<li><p><a class="reference internal" href="#zvstack" id="id11">$00 zvstack</a></p></li>
<li><p><a class="reference internal" href="#open-01-02-03" id="id12">$01 open ($01 $02 $03)</a></p></li>
<li><p><a class="reference internal" href="#lseek" id="id13">$09 lseek</a></p></li>
<li><p><a class="reference internal" href="#ff-exit" id="id14">$FF exit</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">1. Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="ria.html"><span class="doc">RP6502-RIA</span></a> runs a protected 32-bit kernel that you can call from the 6502. The kernel runs on a processor that is significnatly faster than a 6502. This is the only practical way to run modern networking and USB host stacks.</p>
<p>The RP6502 presents an opportunity to create a new type of operating system. A 6502 OS based on the C programming language with familiar POSIX-like operations.</p>
</div>
<div class="section" id="calling-with-fastcall">
<h2><a class="toc-backref" href="#id2">2. Calling with fastcall</a><a class="headerlink" href="#calling-with-fastcall" title="Permalink to this headline">¶</a></h2>
<p>The binary interface is based on fastcall from the <a class="reference external" href="https://cc65.github.io/doc/cc65-intern.html">CC65 Internals</a>. The last parameter is passed by register and everything else is pushed on the stack from left to right. The return value is also passed by register.</p>
<p>The register is known as AX for 16 bits and AXSREG for 32-bits. CC65 keeps SREG in zero page. A and X are the 6502 registers. Let’s look at this example function.</p>
<dl class="function">
<dt>
<code class="sig-name descname">int doit(int arg0, int arg1);</code></dt>
<dd></dd></dl>

<p>The RIA has registers called RIA_A, RIA_X, and RIA_SREG. An int is 16 bits, so we set the RIA_A and RIA_X registers with arg1. I’ll use “A” for the 6502 register and “RIA_A” for the RIA register in this explanation.</p>
<p>Next we push arg0 on the VSTACK. Writing data to the RIA_STACK register does this. It’s a top-down stack, so push each value from left to right and maintain little endian-ness in memory.</p>
<p>Get the operation ID from the function reference and store that in RIA_OP. The operation is running now. You can keep doing 6502 things, like running a loading animation, by polling RIA_BUSY. Or, JSR RIA_RETURN to block.</p>
<p>If you poll, the return values will be in RIA_A, RIA_X, and RIA_SREG. If you JSR RIA_RETURN then A and X will be set upon return. If an error occurs, RIA_ERRNO will be updated. RIA_A and RIX_A will both always be updated to assist with CC65’s interget promotion requirements. RIA_SREG is only updated for 32-bit returhns. RIA_ERRNO is not updated unless there’s an error (like POSIX).</p>
<p>You can now proceed to pull values off the stack. You must pull the entire stack before the next call.</p>
<div class="section" id="short-stacking">
<h3><a class="toc-backref" href="#id3">2.1. Short Stacking</a><a class="headerlink" href="#short-stacking" title="Permalink to this headline">¶</a></h3>
<p>In the never ending pursuit of saving all the clocks, it is possible to save a few on the stack push if you don’t need all the range. This only works on the final int passed. For example:</p>
<dl class="function">
<dt>
<code class="sig-name descname">int doit2it(unsigned long long int arg0, int arg1);</code></dt>
<dd></dd></dl>

<p>Here we are required to pass a 64 bit value, perhaps for a file seek. If you’re only working with 64K files, you only need 16 bits, so you only need to push the two low bytes.</p>
</div>
<div class="section" id="shorter-integers">
<h3><a class="toc-backref" href="#id4">2.2. Shorter Integers</a><a class="headerlink" href="#shorter-integers" title="Permalink to this headline">¶</a></h3>
<p>Many operations can be save a few clocks by ignoring REG_X. All integers are always available as 16 bits to assist with CC65 and integer promotion. However, many operations will ignore REG_X on the register parameter and limit their return to fit in REG_A. This will be documented below as “A regs”.</p>
</div>
<div class="section" id="bulk-data">
<h3><a class="toc-backref" href="#id5">2.3. Bulk Data</a><a class="headerlink" href="#bulk-data" title="Permalink to this headline">¶</a></h3>
<p>Many functions come in three flavors. These functions pass blocks of data. For example, reads and writes. They all have a “const char *” parameter. This pointer is passed by special means. This is because the kernel can only change registers, not 6502 RAM.</p>
<div class="section" id="xx-0-bulk-vstack-operations">
<h4><a class="toc-backref" href="#id6">2.2.1. $XX+0 Bulk VSTACK Operations</a><a class="headerlink" href="#xx-0-bulk-vstack-operations" title="Permalink to this headline">¶</a></h4>
<p>If the bulk data is 256 bytes or less, you can pass it on the VSTACK. If you’re passing a string, like a filename, you can omit the trailing zero. Strings are still limited to a length of 255 though. Don’t pass a “pointer” on the stack, just push or pull the data.</p>
<p>The CC65 library uses these stack functions. It will break up large reads and writes into multiple calls. This makes C library functions like fread() work exactly as expected with no unwanted side effects. However, the C standard library has no concept of VRAM, so it’s worth learning how to use the kernel API if you’re doing anything with graphics and sound.</p>
</div>
<div class="section" id="xx-1-and-xx-2-bulk-vram-operations">
<h4><a class="toc-backref" href="#id7">2.2.2. $XX+1 and $XX+2 Bulk VRAM Operations</a><a class="headerlink" href="#xx-1-and-xx-2-bulk-vram-operations" title="Permalink to this headline">¶</a></h4>
<p>These functions get their pointer from RIA_ADDR0 or RIA_ADDR1. Setting an ADDR register sets the pointer. It does not matter if the value later changes with STEP and RW, the pointer is what you set initially. This way you can set the ADDR, write some data, <em>not</em> re-set the ADDR, and call the OP.</p>
<p>Calling these functions updates VRAM. If you’re loading graphics, you can load exactly what you need right where you need it without the 6502 doing any work.</p>
</div>
</div>
</div>
<div class="section" id="function-reference">
<h2><a class="toc-backref" href="#id8">1. Function Reference</a><a class="headerlink" href="#function-reference" title="Permalink to this headline">¶</a></h2>
<p>These C declarations will “just work” in CC65 when using the SDK because they have an implemention that will block and move data between 6502 RAM and the VSTACK. Two additional C functions may be provided for working with VRAM. The first declaration (without numeric suffix) is the main prototype for the binary interface as described above.</p>
<p>Calling kernel API functions from the C SDK will will do any copying work for you and block until the operation completes. The numbered VRAM variants will use their respective RW portal and do not preserve the VRAM registers.</p>
<p>While calling from C SDK is easy and usually fast enough, you can also use the API from C in the same way an assembly program would.</p>
<div class="section" id="warning">
<h3><a class="toc-backref" href="#id9">Warning</a><a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h3>
<p>This is not stable. Expect lots of little changes.</p>
</div>
<div class="section" id="typedefs">
<h3><a class="toc-backref" href="#id10">Typedefs</a><a class="headerlink" href="#typedefs" title="Permalink to this headline">¶</a></h3>
<dl class="type">
<dt id="c.uint16_t">
int <code class="sig-name descname">uint16_t</code><a class="headerlink" href="#c.uint16_t" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="type">
<dt id="c.vram_ptr">
<a class="reference internal" href="#c.uint16_t" title="uint16_t">uint16_t</a> <code class="sig-name descname">vram_ptr</code><a class="headerlink" href="#c.vram_ptr" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="zvstack">
<h3><a class="toc-backref" href="#id11">$00 zvstack</a><a class="headerlink" href="#zvstack" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt>
<code class="sig-name descname">void zvstack(void);</code></dt>
<dd><p>Abandon the vstack by resetting the pointer. Not needed for normal operation, but some performance tricks can be achieved. This is the only operation that doesn’t require waiting for completion.</p>
</dd></dl>

</div>
<div class="section" id="open-01-02-03">
<h3><a class="toc-backref" href="#id12">$01 open ($01 $02 $03)</a><a class="headerlink" href="#open-01-02-03" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt>
<code class="sig-name descname">int open(const char *path, int oflag);</code></dt>
<dd></dd></dl>

<dl class="function">
<dt>
<code class="sig-name descname">int open0(vram_ptr addr0, int oflag);</code></dt>
<dd></dd></dl>

<dl class="function">
<dt>
<code class="sig-name descname">int open1(vram_ptr addr1, int oflag);</code></dt>
<dd><p>Create a connection between a file and a file descriptor.</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>path</strong> – Pathname to a file.</p></li>
<li><p><strong>oflag</strong> – Bitfield of options.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>File descriptor. -1 on error.</p>
</dd>
<dt class="field-odd">A regs</dt>
<dd class="field-odd"><p>return, oflag</p>
</dd>
<dt class="field-even">Errno</dt>
<dd class="field-even"><p>FR_DISK_ERR, FR_INT_ERR, FR_NOT_READY, FR_NO_FILE, FR_NO_PATH, FR_INVALID_NAME, FR_DENIED, FR_EXIST, FR_INVALID_OBJECT, FR_WRITE_PROTECTED, FR_INVALID_DRIVE, FR_NOT_ENABLED, FR_NO_FILESYSTEM, FR_TIMEOUT, FR_LOCKED, FR_NOT_ENOUGH_CORE, FR_TOO_MANY_OPEN_FILES</p>
</dd>
<dt class="field-odd">Options</dt>
<dd class="field-odd"><div class="line-block">
<div class="line">O_RDONLY 0x01</div>
<div class="line-block">
<div class="line">Open for reading only.</div>
</div>
<div class="line">O_WRONLY 0x02</div>
<div class="line-block">
<div class="line">Open for writing only.</div>
</div>
<div class="line">O_RDWR 0x03</div>
<div class="line-block">
<div class="line">Open for reading and writing.</div>
</div>
<div class="line">O_CREAT 0x10</div>
<div class="line-block">
<div class="line">Create the file if it does not exist.</div>
</div>
<div class="line">O_TRUNC 0x20</div>
<div class="line-block">
<div class="line">Truncate the file length to 0 after opening.</div>
</div>
<div class="line">O_APPEND 0x40</div>
<div class="line-block">
<div class="line">Read/write pointer is set end of the file.</div>
</div>
<div class="line">O_EXCL 0x80</div>
<div class="line-block">
<div class="line">If O_CREAT and O_EXCL are set, fail if the file exists.</div>
</div>
</div>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="lseek">
<h3><a class="toc-backref" href="#id13">$09 lseek</a><a class="headerlink" href="#lseek" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="c.lseek">
long int <code class="sig-name descname">lseek</code><span class="sig-paren">(</span>unsigned long long int<em> offset</em>, int<em> fildes</em><span class="sig-paren">)</span><a class="headerlink" href="#c.lseek" title="Permalink to this definition">¶</a></dt>
<dd><p>Move the read/write pointer. This can also expand the file.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>offset</strong> – Position to move to in file.</p></li>
<li><p><strong>fildes</strong> – File descriptor from open().</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Read/write position. -1 on error. If this value would be too large for a long, the returned value will be 0x0FFFFFFF.</p>
</dd>
<dt class="field-odd">A regs</dt>
<dd class="field-odd"><p>fildes</p>
</dd>
<dt class="field-even">Errno</dt>
<dd class="field-even"><p>FR_DISK_ERR, FR_INT_ERR, FR_INVALID_OBJECT, FR_TIMEOUT</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="ff-exit">
<h3><a class="toc-backref" href="#id14">$FF exit</a><a class="headerlink" href="#ff-exit" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt>
<code class="sig-name descname">void exit(int status);</code></dt>
<dd><p>Halt the 6502 and return to the kernel command interface. This is the only operations that does not return. RESB will be pulled down before the next instruction can execute.</p>
</dd></dl>

</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">RP6502</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ria.html">RIA</a></li>
<li class="toctree-l1"><a class="reference internal" href="vga.html">VGA</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calling-with-fastcall">2. Calling with fastcall</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#short-stacking">2.1. Short Stacking</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shorter-integers">2.2. Shorter Integers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bulk-data">2.3. Bulk Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#xx-0-bulk-vstack-operations">2.2.1. $XX+0 Bulk VSTACK Operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#xx-1-and-xx-2-bulk-vram-operations">2.2.2. $XX+1 and $XX+2 Bulk VRAM Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#function-reference">1. Function Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#warning">Warning</a></li>
<li class="toctree-l3"><a class="reference internal" href="#typedefs">Typedefs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#zvstack">$00 zvstack</a></li>
<li class="toctree-l3"><a class="reference internal" href="#open-01-02-03">$01 open ($01 $02 $03)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lseek">$09 lseek</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ff-exit">$FF exit</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="vga.html" title="previous chapter">RP6502-VGA</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023 Rumbledethumps.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/api.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>